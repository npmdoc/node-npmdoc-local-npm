<html><head></head><body><div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a href="https://github.com/nolanlawson/local-npm#readme">local-npm (v1.6.0)</a>
</h1>
<h4>Local and offline-first npm mirror</h4>
<div class="apidocSectionDiv"><a href="#apidoc.tableOfContents" id="apidoc.tableOfContents"><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.local-npm">module local-npm</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.local-npm.local-npm">
            function <span class="apidocSignatureSpan"></span>local-npm
            <span class="apidocSignatureSpan">(argv)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">local-npm.</span>logger</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.local-npm.logger">module local-npm.logger</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.local-npm.logger.cached">
            function <span class="apidocSignatureSpan">local-npm.logger.</span>cached
            <span class="apidocSignatureSpan">(pkg, version)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.local-npm.logger.code">
            function <span class="apidocSignatureSpan">local-npm.logger.</span>code
            <span class="apidocSignatureSpan">(msg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.local-npm.logger.error">
            function <span class="apidocSignatureSpan">local-npm.logger.</span>error
            <span class="apidocSignatureSpan">(msg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.local-npm.logger.hit">
            function <span class="apidocSignatureSpan">local-npm.logger.</span>hit
            <span class="apidocSignatureSpan">(pkg, version)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.local-npm.logger.info">
            function <span class="apidocSignatureSpan">local-npm.logger.</span>info
            <span class="apidocSignatureSpan">(msg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.local-npm.logger.miss">
            function <span class="apidocSignatureSpan">local-npm.logger.</span>miss
            <span class="apidocSignatureSpan">(pkg, version)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.local-npm.logger.silly">
            function <span class="apidocSignatureSpan">local-npm.logger.</span>silly
            <span class="apidocSignatureSpan">(msg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.local-npm.logger.status">
            function <span class="apidocSignatureSpan">local-npm.logger.</span>status
            <span class="apidocSignatureSpan">(seq, percent)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.local-npm.logger.time">
            function <span class="apidocSignatureSpan">local-npm.logger.</span>time
            <span class="apidocSignatureSpan">(msg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.local-npm.logger.timeEnd">
            function <span class="apidocSignatureSpan">local-npm.logger.</span>timeEnd
            <span class="apidocSignatureSpan">(msg)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.local-npm.logger.warn">
            function <span class="apidocSignatureSpan">local-npm.logger.</span>warn
            <span class="apidocSignatureSpan">(msg)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.local-npm" id="apidoc.module.local-npm">module local-npm</a></h1>


    <h2>
        <a href="#apidoc.element.local-npm.local-npm" id="apidoc.element.local-npm.local-npm">
        function <span class="apidocSignatureSpan"></span>local-npm
        <span class="apidocSignatureSpan">(argv)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">local-npm = function (argv) {
  var FAT_REMOTE = argv.r;
  var SKIM_REMOTE = argv.R;
  var port = argv.p;
  var pouchPort = argv.P;
  var localBase = argv.u;
  localBase = localBase.replace(/:5080$/, ':' + port); // port is configurable
  var loglevel  = argv.l;
  var directory = path.resolve(argv.d);
  mkdirp.sync(directory);
  loglevel = levels(loglevel);
  var startingTimeout = 1000;
  logger.silly('\nWelcome!');
  logger.info('To start using local-npm, just run: ');
  logger.code('\n  $ npm set registry ' + localBase);
  logger.info('\nTo switch back, you can run: ');
  logger.code('\n  $ npm set registry ' + FAT_REMOTE);
  var backoff = 1.1;
  var app = express();
  var PouchDB;

  PouchDB = pouchServerLite(argv).PouchDB;

  var skimRemote = new PouchDB(SKIM_REMOTE);
  var skimLocal = new PouchDB('skimdb', {
    auto_compaction: true
  });
  var db = level(path.resolve(directory, 'binarydb'));


  if (loglevel &gt; 1) {
    app.use(morgan('dev'));
  }
  app.use(compression());
  app.use(favicon(__dirname + '/favicon.ico'));

  //
  // rudimentary UI based on npm-browser
  //
  logger.info('\nA simple npm-like UI is available here: http://127.0.0.1:' + port + '/_browse');

  app.use('/_browse', express.static(__dirname + '/www'));
  function redirectToSkimdb(req, res) {
    var skimUrl = 'http://localhost:' + pouchPort + '/skimdb';
    var get = request.get(req.originalUrl.replace(/^\/_skimdb/, skimUrl));
    get.on('error', function (err) {
      logger.warn("couldn't proxy to skimdb");
      logger.warn(err);
    });
    get.pipe(res);
  }
  app.get('/_skimdb', redirectToSkimdb);
  app.get('/_skimdb*', redirectToSkimdb);

  app.get('/', function (req, res) {
    Promise.all([skimLocal.info(), getCount()]).then(function (resp) {

      res.json({
        'local-npm': 'welcome',
        version: pkg.version,
        db: resp[0],
        tarballs: resp[1]
      });
    });
  });


  //
  // utils
  //

  function massageMetadata(urlBase, doc) {
    var name = doc.name;
    var versions = Object.keys(doc.versions);
    for (var i = 0, len = versions.length; i &lt; len; i++) {
      var version = versions[i];
      if (!semver.valid(version)) {
        // apparently some npm modules like handlebars
        // have invalid semver ranges, and npm deletes them
        // on-the-fly
        delete doc.versions[version];
      } else {
        var tgz = urlBase + '/' + 'tarballs/' + name + '/' + version + '.tgz';
        doc.versions[version].dist.tarball = tgz;
      }
    }
    return doc;
  }

  function sendBinary(res, buffer) {
    res.set('content-type', 'application/octet-stream');
    res.set('content-length', buffer.length);
    return res.send(buffer);
  }

  function cacheResponse(res, etag) {
    // do this to be more like registry.npmjs.com. not sure if it
    // actually has a benefit, though
    res.set('ETag', '"' + etag + '"');
    res.set('Cache-Control', 'max-age=300');
  }

  // TODO: this is an error-prone way to check this. We should probably
  // send an HTTP request to it and check the response to detect local-npm.
  var fatRemoteIsAnotherLocalNpm =
    FAT_REMOTE !== 'https://registry.npmjs.org' &amp;&amp;
    FAT_REMOTE !== 'https://registry.npmjs.org/' &amp;&amp;
    FAT_REMOTE !== 'http://registry.npmjs.org' &amp;&amp;
    FAT_REMOTE !== 'http://registry.npmjs.org/';

  //
  // actual server logic
  //
  app.get('/:name/:version', function (req, res) {
    skimLocal.get(req.params.name).catch(function () {
      return skimRemote.get(req.params.name);
    }).then(function (doc) {
      var packageMetadata = massageMetadata(localBase, doc);
      var versionMetadata = findVersion(packageMetadata, req.params.version);
      if (versionMetadata) {
        cacheResponse(res, doc._rev);
        res.json(versionMetadata);
      } else {
        res.status(404).json({
          error: 'version not found: ' + req.params.version
        });
      }
    }).catch(function () {
      request.get(FAT_REMOTE + req.url)
          .on('error', function(err) {
            logger.warn('error getting data for package:' + req.params.name + 'version: '+req.pa ...</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.local-npm.logger" id="apidoc.module.local-npm.logger">module local-npm.logger</a></h1>


    <h2>
        <a href="#apidoc.element.local-npm.logger.cached" id="apidoc.element.local-npm.logger.cached">
        function <span class="apidocSignatureSpan">local-npm.logger.</span>cached
        <span class="apidocSignatureSpan">(pkg, version)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">cached = function (pkg, version) {
  if (level &gt; 1) {
    log('downloaded '.grey + pkg.green + ' at version '.grey + version.green +
      ' and saved it locally'.grey);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      next();
    }, function (next) {
      next();
      var buffer = Buffer.concat(buffs);
      logger.timeEnd('request.get(' + dist.tarball + ')');
      sendBinary(res, buffer);
      db.put(id, buffer, function (err) {
        logger.<span class="apidocCodeKeywordSpan">cached</span>(pkgName, pkgVersion);
        if (err) {
          logger.info(err);
        }
      });
    }));
  });
}).catch(function (err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.local-npm.logger.code" id="apidoc.element.local-npm.logger.code">
        function <span class="apidocSignatureSpan">local-npm.logger.</span>code
        <span class="apidocSignatureSpan">(msg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">code = function (msg) {
  msg = wrap(msg);
  if (level &gt; 1) {
    log(msg.white);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var loglevel  = argv.l;
var directory = path.resolve(argv.d);
mkdirp.sync(directory);
loglevel = levels(loglevel);
var startingTimeout = 1000;
logger.silly('\nWelcome!');
logger.info('To start using local-npm, just run: ');
logger.<span class="apidocCodeKeywordSpan">code</span>('\n  $ npm set registry ' + localBase);
logger.info('\nTo switch back, you can run: ');
logger.code('\n  $ npm set registry ' + FAT_REMOTE);
var backoff = 1.1;
var app = express();
var PouchDB;

PouchDB = pouchServerLite(argv).PouchDB;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.local-npm.logger.error" id="apidoc.element.local-npm.logger.error">
        function <span class="apidocSignatureSpan">local-npm.logger.</span>error
        <span class="apidocSignatureSpan">(msg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">error = function (msg) {
  msg = wrap(msg);
  log(msg.red);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
app.use(pouchDBApp);

app.listen(port, function () {
  logger.info('\nPouchDB Server listening on port ' + port + '.');
  logger.info('Navigate to http://localhost:' + port + '/_utils for the Fauxton UI.\n');
}).on('error', /* istanbul ignore next */ function (e) {
  if (e.code === 'EADDRINUSE') {
    logger.<span class="apidocCodeKeywordSpan">error</span>('\nError: Port ' + port + ' is already in use.');
    logger.error('Try another one, e.g. pouchdb-server -p ' +
      (parseInt(port) + 1) + '\n');
  } else {
    logger.error('Uncaught error: ' + e);
    logger.error(e.stack);
  }
});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.local-npm.logger.hit" id="apidoc.element.local-npm.logger.hit">
        function <span class="apidocSignatureSpan">local-npm.logger.</span>hit
        <span class="apidocSignatureSpan">(pkg, version)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">hit = function (pkg, version) {
  if (level &gt; 1) {
    log('found tarball for '.grey + pkg.green + ' at version '.grey +
      version.green);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
if (!err) {
  var hash = crypto.createHash('sha1');
  hash.update(buffer);
  if (dist.shasum !== hash.digest('hex')) {
    // happens when we write garbage to disk somehow
    logger.warn('hashes don\'t match, not returning');
  } else {
    logger.<span class="apidocCodeKeywordSpan">hit</span>(pkgName, pkgVersion);
    return sendBinary(res, buffer);
  }
}
logger.miss(pkgName, pkgVersion);
var buffs = [];
logger.time('request.get(' + dist.tarball + ')');
request.get(dist.tarball).on('error', function (err) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.local-npm.logger.info" id="apidoc.element.local-npm.logger.info">
        function <span class="apidocSignatureSpan">local-npm.logger.</span>info
        <span class="apidocSignatureSpan">(msg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">info = function (msg) {
  msg = wrap(msg);
  if (level &gt; 1) {
    log(msg.cyan);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
localBase = localBase.replace(/:5080$/, ':' + port); // port is configurable
var loglevel  = argv.l;
var directory = path.resolve(argv.d);
mkdirp.sync(directory);
loglevel = levels(loglevel);
var startingTimeout = 1000;
logger.silly('\nWelcome!');
logger.<span class="apidocCodeKeywordSpan">info</span>('To start using local-npm, just run: ');
logger.code('\n  $ npm set registry ' + localBase);
logger.info('\nTo switch back, you can run: ');
logger.code('\n  $ npm set registry ' + FAT_REMOTE);
var backoff = 1.1;
var app = express();
var PouchDB;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.local-npm.logger.miss" id="apidoc.element.local-npm.logger.miss">
        function <span class="apidocSignatureSpan">local-npm.logger.</span>miss
        <span class="apidocSignatureSpan">(pkg, version)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">miss = function (pkg, version) {
  if (level &gt; 1) {
    log('not cached '.grey + pkg.green + ' at version '.grey + version.green +
      ', downloading...'.grey);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    // happens when we write garbage to disk somehow
    logger.warn('hashes don\'t match, not returning');
  } else {
    logger.hit(pkgName, pkgVersion);
    return sendBinary(res, buffer);
  }
}
logger.<span class="apidocCodeKeywordSpan">miss</span>(pkgName, pkgVersion);
var buffs = [];
logger.time('request.get(' + dist.tarball + ')');
request.get(dist.tarball).on('error', function (err) {
  logger.info(err);
  res.status(500).send('you are offline and this package isn\'t cached');
}).pipe(through(function (chunk, _, next) {
  buffs.push(chunk);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.local-npm.logger.silly" id="apidoc.element.local-npm.logger.silly">
        function <span class="apidocSignatureSpan">local-npm.logger.</span>silly
        <span class="apidocSignatureSpan">(msg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">silly = function (msg) {
  msg = wrap(msg);
  if (level &gt; 1) {
    log(msg.rainbow.bold);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var localBase = argv.u;
localBase = localBase.replace(/:5080$/, ':' + port); // port is configurable
var loglevel  = argv.l;
var directory = path.resolve(argv.d);
mkdirp.sync(directory);
loglevel = levels(loglevel);
var startingTimeout = 1000;
logger.<span class="apidocCodeKeywordSpan">silly</span>('\nWelcome!');
logger.info('To start using local-npm, just run: ');
logger.code('\n  $ npm set registry ' + localBase);
logger.info('\nTo switch back, you can run: ');
logger.code('\n  $ npm set registry ' + FAT_REMOTE);
var backoff = 1.1;
var app = express();
var PouchDB;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.local-npm.logger.status" id="apidoc.element.local-npm.logger.status">
        function <span class="apidocSignatureSpan">local-npm.logger.</span>status
        <span class="apidocSignatureSpan">(seq, percent)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">status = function (seq, percent) {
  if (level &gt; 1) {
    log('Replicating skimdb, last_seq is: '.grey + String(seq).green +
      ' ('.grey + String(percent).green + '%'.green + ')'.grey);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}).then(function (doc) {
  var packageMetadata = massageMetadata(localBase, doc);
  var versionMetadata = findVersion(packageMetadata, req.params.version);
  if (versionMetadata) {
    cacheResponse(res, doc._rev);
    res.json(versionMetadata);
  } else {
    res.<span class="apidocCodeKeywordSpan">status</span>(404).json({
      error: 'version not found: ' + req.params.version
    });
  }
}).catch(function () {
  request.get(FAT_REMOTE + req.url)
      .on('error', function(err) {
        logger.warn('error getting data for package:' + req.params.name + 'version: '+req.params.version + &amp;#
x27; with error:'+err);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.local-npm.logger.time" id="apidoc.element.local-npm.logger.time">
        function <span class="apidocSignatureSpan">local-npm.logger.</span>time
        <span class="apidocSignatureSpan">(msg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">time = function (msg) {
  msg = wrap(msg);
  if (level &gt; 2) {
    console.time(msg);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
          });
        })
        .pipe(res);
  });
});
app.get('/:name', function (req, res) {
  var name = req.params.name;
  logger.<span class="apidocCodeKeywordSpan">time</span>('1: skimLocal.get(' + name + ')');
  skimLocal.get(name).catch(function () {
    return skimRemote.get(name);
  }).then(function (doc) {
    var modifiedDoc = massageMetadata(localBase, doc);
    logger.timeEnd('1: skimLocal.get(' + name + ')');
    cacheResponse(res, doc._rev);
    res.json(modifiedDoc);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.local-npm.logger.timeEnd" id="apidoc.element.local-npm.logger.timeEnd">
        function <span class="apidocSignatureSpan">local-npm.logger.</span>timeEnd
        <span class="apidocSignatureSpan">(msg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">timeEnd = function (msg) {
  msg = wrap(msg);
  if (level &gt; 2) {
    console.timeEnd(msg);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  app.get('/:name', function (req, res) {
var name = req.params.name;
logger.time('1: skimLocal.get(' + name + ')');
skimLocal.get(name).catch(function () {
  return skimRemote.get(name);
}).then(function (doc) {
  var modifiedDoc = massageMetadata(localBase, doc);
  logger.<span class="apidocCodeKeywordSpan">timeEnd</span>('1: skimLocal.get(' + name + ')');
  cacheResponse(res, doc._rev);
  res.json(modifiedDoc);
}).catch(function () {
  request.get(FAT_REMOTE + req.url)
      .on('error', function(err) {
        logger.warn('error getting data for package:' + name + ' error: '+err);
        res.status(500).json({
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.local-npm.logger.warn" id="apidoc.element.local-npm.logger.warn">
        function <span class="apidocSignatureSpan">local-npm.logger.</span>warn
        <span class="apidocSignatureSpan">(msg)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">warn = function (msg) {
  msg = wrap(msg);
  if (level &gt; 0) {
    log(msg.yellow);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
logger.info('\nA simple npm-like UI is available here: http://127.0.0.1:' + port + '/_browse');

app.use('/_browse', express.static(__dirname + '/www'));
function redirectToSkimdb(req, res) {
  var skimUrl = 'http://localhost:' + pouchPort + '/skimdb';
  var get = request.get(req.originalUrl.replace(/^\/_skimdb/, skimUrl));
  get.on('error', function (err) {
    logger.<span class="apidocCodeKeywordSpan">warn</span>("couldn't proxy to skimdb");
    logger.warn(err);
  });
  get.pipe(res);
}
app.get('/_skimdb', redirectToSkimdb);
app.get('/_skimdb*', redirectToSkimdb);
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
</body></html>